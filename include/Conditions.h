#pragma once

// 90% copied from po3: https://github.com/powerof3/LightPlacer/blob/master/src/ConditionParser.h

using FUNC_ID = RE::FUNCTION_DATA::FunctionID;
using OP_CODE = RE::CONDITION_ITEM_DATA::OpCode;

using PARAM_TYPE = RE::SCRIPT_PARAM_TYPE;
using PARAMS = std::pair<std::optional<PARAM_TYPE>, std::optional<PARAM_TYPE>>;


class ConditionParser
{
public:
	static void BuildCondition(std::shared_ptr<RE::TESCondition>& a_conditionLoaded, const std::string& a_condition);

private:
	union VOID_PARAM
	{
		char* c;
		std::int32_t i;
		float        f;
		RE::TESForm* ptr;
	};

	static PARAMS       GetFuncType(FUNC_ID a_funcID);
	static RE::TESForm* LookupForm(const std::string& a_str);
	static bool         ParseVoidParam(const std::string& a_str, VOID_PARAM& a_param, PARAM_TYPE a_type);

	static constexpr frozen::unordered_map<std::string_view, std::uint32_t, 402> funcIDs{
		{ "GetWantBlocking"sv, 0 },
		{ "GetDistance"sv, 1 },
		{ "GetLocked"sv, 5 },
		{ "GetPos"sv, 6 },
		{ "GetAngle"sv, 8 },
		{ "GetStartingPos"sv, 10 },
		{ "GetStartingAngle"sv, 11 },
		{ "GetSecondsPassed"sv, 12 },
		{ "GetActorValue"sv, 14 },
		{ "GetCurrentTime"sv, 18 },
		{ "GetScale"sv, 24 },
		{ "IsMoving"sv, 25 },
		{ "IsTurning"sv, 26 },
		{ "GetLineOfSight"sv, 27 },
		{ "GetInSameCell"sv, 32 },
		{ "GetDisabled"sv, 35 },
		{ "MenuMode"sv, 36 },
		{ "GetDisease"sv, 39 },
		{ "GetClothingValue"sv, 41 },
		{ "SameFaction"sv, 42 },
		{ "SameRace"sv, 43 },
		{ "SameSex"sv, 44 },
		{ "GetDetected"sv, 45 },
		{ "GetDead"sv, 46 },
		{ "GetItemCount"sv, 47 },
		{ "GetGold"sv, 48 },
		{ "GetSleeping"sv, 49 },
		{ "GetTalkedToPC"sv, 50 },
		{ "GetScriptVariable"sv, 53 },
		{ "GetQuestRunning"sv, 56 },
		{ "GetStage"sv, 58 },
		{ "GetStageDone"sv, 59 },
		{ "GetFactionRankDifference"sv, 60 },
		{ "GetAlarmed"sv, 61 },
		{ "IsRaining"sv, 62 },
		{ "GetAttacked"sv, 63 },
		{ "GetIsCreature"sv, 64 },
		{ "GetLockLevel"sv, 65 },
		{ "GetShouldAttack"sv, 66 },
		{ "GetInCell"sv, 67 },
		{ "GetIsClass"sv, 68 },
		{ "GetIsRace"sv, 69 },
		{ "GetIsSex"sv, 70 },
		{ "GetInFaction"sv, 71 },
		{ "GetIsID"sv, 72 },
		{ "GetFactionRank"sv, 73 },
		{ "GetGlobalValue"sv, 74 },
		{ "IsSnowing"sv, 75 },
		{ "GetRandomPercent"sv, 77 },
		{ "GetQuestVariable"sv, 79 },
		{ "GetLevel"sv, 80 },
		{ "IsRotating"sv, 81 },
		{ "GetDeadCount"sv, 84 },
		{ "GetIsAlerted"sv, 91 },
		{ "GetPlayerControlsDisabled"sv, 98 },
		{ "GetHeadingAngle"sv, 99 },
		{ "IsWeaponMagicOut"sv, 101 },
		{ "IsTorchOut"sv, 102 },
		{ "IsShieldOut"sv, 103 },
		{ "IsFacingUp"sv, 106 },
		{ "GetKnockedState"sv, 107 },
		{ "GetWeaponAnimType"sv, 108 },
		{ "IsWeaponSkillType"sv, 109 },
		{ "GetCurrentAIPackage"sv, 110 },
		{ "IsWaiting"sv, 111 },
		{ "IsIdlePlaying"sv, 112 },
		{ "IsIntimidatedbyPlayer"sv, 116 },
		{ "IsPlayerInRegion"sv, 117 },
		{ "GetActorAggroRadiusViolated"sv, 118 },
		{ "GetCrime"sv, 122 },
		{ "IsGreetingPlayer"sv, 123 },
		{ "IsGuard"sv, 125 },
		{ "HasBeenEaten"sv, 127 },
		{ "GetStaminaPercentage"sv, 128 },
		{ "GetPCIsClass"sv, 129 },
		{ "GetPCIsRace"sv, 130 },
		{ "GetPCIsSex"sv, 131 },
		{ "GetPCInFaction"sv, 132 },
		{ "SameFactionAsPC"sv, 133 },
		{ "SameRaceAsPC"sv, 134 },
		{ "SameSexAsPC"sv, 135 },
		{ "GetIsReference"sv, 136 },
		{ "IsTalking"sv, 141 },
		{ "GetWalkSpeed"sv, 142 },
		{ "GetCurrentAIProcedure"sv, 143 },
		{ "GetTrespassWarningLevel"sv, 144 },
		{ "IsTrespassing"sv, 145 },
		{ "IsInMyOwnedCell"sv, 146 },
		{ "GetWindSpeed"sv, 147 },
		{ "GetCurrentWeatherPercent"sv, 148 },
		{ "GetIsCurrentWeather"sv, 149 },
		{ "IsContinuingPackagePCNear"sv, 150 },
		{ "GetIsCrimeFaction"sv, 152 },
		{ "CanHaveFlames"sv, 153 },
		{ "HasFlames"sv, 154 },
		{ "GetOpenState"sv, 157 },
		{ "GetSitting"sv, 159 },
		{ "GetIsCurrentPackage"sv, 161 },
		{ "IsCurrentFurnitureRef"sv, 162 },
		{ "IsCurrentFurnitureObj"sv, 163 },
		{ "GetDayOfWeek"sv, 170 },
		{ "GetTalkedToPCParam"sv, 172 },
		{ "IsPCSleeping"sv, 175 },
		{ "IsPCAMurderer"sv, 176 },
		{ "HasSameEditorLocAsRef"sv, 180 },
		{ "HasSameEditorLocAsRefAlias"sv, 181 },
		{ "GetEquipped"sv, 182 },
		{ "IsSwimming"sv, 185 },
		{ "GetAmountSoldStolen"sv, 190 },
		{ "GetIgnoreCrime"sv, 192 },
		{ "GetPCExpelled"sv, 193 },
		{ "GetPCFactionMurder"sv, 195 },
		{ "GetPCEnemyofFaction"sv, 197 },
		{ "GetPCFactionAttack"sv, 199 },
		{ "GetDestroyed"sv, 203 },
		{ "HasMagicEffect"sv, 214 },
		{ "GetDefaultOpen"sv, 215 },
		{ "GetAnimAction"sv, 219 },
		{ "IsSpellTarget"sv, 223 },
		{ "GetVATSMode"sv, 224 },
		{ "GetPersuasionNumber"sv, 225 },
		{ "GetVampireFeed"sv, 226 },
		{ "GetCannibal"sv, 227 },
		{ "GetIsClassDefault"sv, 228 },
		{ "GetClassDefaultMatch"sv, 229 },
		{ "GetInCellParam"sv, 230 },
		{ "GetVatsTargetHeight"sv, 235 },
		{ "GetIsGhost"sv, 237 },
		{ "GetUnconscious"sv, 242 },
		{ "GetRestrained"sv, 244 },
		{ "GetIsUsedItem"sv, 246 },
		{ "GetIsUsedItemType"sv, 247 },
		{ "IsScenePlaying"sv, 248 },
		{ "IsInDialogueWithPlayer"sv, 249 },
		{ "GetLocationCleared"sv, 250 },
		{ "GetIsPlayableRace"sv, 254 },
		{ "GetOffersServicesNow"sv, 255 },
		{ "HasAssociationType"sv, 258 },
		{ "HasFamilyRelationship"sv, 259 },
		{ "HasParentRelationship"sv, 261 },
		{ "IsWarningAbout"sv, 262 },
		{ "IsWeaponOut"sv, 263 },
		{ "HasSpell"sv, 264 },
		{ "IsTimePassing"sv, 265 },
		{ "IsPleasant"sv, 266 },
		{ "IsCloudy"sv, 267 },
		{ "IsSmallBump"sv, 274 },
		{ "GetBaseActorValue"sv, 277 },
		{ "IsOwner"sv, 278 },
		{ "IsCellOwner"sv, 280 },
		{ "IsHorseStolen"sv, 282 },
		{ "IsLeftUp"sv, 285 },
		{ "IsSneaking"sv, 286 },
		{ "IsRunning"sv, 287 },
		{ "GetFriendHit"sv, 288 },
		{ "IsInCombat"sv, 289 },
		{ "IsInInterior"sv, 300 },
		{ "IsWaterObject"sv, 304 },
		{ "GetPlayerAction"sv, 305 },
		{ "IsActorUsingATorch"sv, 306 },
		{ "IsXBox"sv, 309 },
		{ "GetInWorldspace"sv, 310 },
		{ "GetPCMiscStat"sv, 312 },
		{ "GetPairedAnimation"sv, 313 },
		{ "IsActorAVictim"sv, 314 },
		{ "GetTotalPersuasionNumber"sv, 315 },
		{ "GetIdleDoneOnce"sv, 318 },
		{ "GetNoRumors"sv, 320 },
		{ "GetCombatState"sv, 323 },
		{ "GetWithinPackageLocation"sv, 325 },
		{ "IsRidingMount"sv, 327 },
		{ "IsFleeing"sv, 329 },
		{ "IsInDangerousWater"sv, 332 },
		{ "GetIgnoreFriendlyHits"sv, 338 },
		{ "IsPlayersLastRiddenMount"sv, 339 },
		{ "IsActor"sv, 353 },
		{ "IsEssential"sv, 354 },
		{ "IsPlayerMovingIntoNewSpace"sv, 358 },
		{ "GetInCurrentLoc"sv, 359 },
		{ "GetInCurrentLocAlias"sv, 360 },
		{ "GetTimeDead"sv, 361 },
		{ "HasLinkedRef"sv, 362 },
		{ "IsChild"sv, 365 },
		{ "GetStolenItemValueNoCrime"sv, 366 },
		{ "GetLastPlayerAction"sv, 367 },
		{ "IsPlayerActionActive"sv, 368 },
		{ "IsTalkingActivatorActor"sv, 370 },
		{ "IsInList"sv, 372 },
		{ "GetStolenItemValue"sv, 373 },
		{ "GetCrimeGoldViolent"sv, 375 },
		{ "GetCrimeGoldNonviolent"sv, 376 },
		{ "HasShout"sv, 378 },
		{ "GetHasNote"sv, 381 },
		{ "GetHitLocation"sv, 390 },
		{ "IsPC1stPerson"sv, 391 },
		{ "GetCauseofDeath"sv, 396 },
		{ "IsLimbGone"sv, 397 },
		{ "IsWeaponInList"sv, 398 },
		{ "IsBribedbyPlayer"sv, 402 },
		{ "GetRelationshipRank"sv, 403 },
		{ "GetVATSValue"sv, 407 },
		{ "IsKiller"sv, 408 },
		{ "IsKillerObject"sv, 409 },
		{ "GetFactionCombatReaction"sv, 410 },
		{ "Exists"sv, 414 },
		{ "GetGroupMemberCount"sv, 415 },
		{ "GetGroupTargetCount"sv, 416 },
		{ "GetIsVoiceType"sv, 426 },
		{ "GetPlantedExplosive"sv, 427 },
		{ "IsScenePackageRunning"sv, 429 },
		{ "GetHealthPercentage"sv, 430 },
		{ "GetIsObjectType"sv, 432 },
		{ "GetDialogueEmotion"sv, 434 },
		{ "GetDialogueEmotionValue"sv, 435 },
		{ "GetIsCreatureType"sv, 437 },
		{ "GetInCurrentLocFormList"sv, 444 },
		{ "GetInZone"sv, 445 },
		{ "GetVelocity"sv, 446 },
		{ "GetGraphVariableFloat"sv, 447 },
		{ "HasPerk"sv, 448 },
		{ "GetFactionRelation"sv, 449 },
		{ "IsLastIdlePlayed"sv, 450 },
		{ "GetPlayerTeammate"sv, 453 },
		{ "GetPlayerTeammateCount"sv, 454 },
		{ "GetActorCrimePlayerEnemy"sv, 458 },
		{ "GetCrimeGold"sv, 459 },
		{ "IsPlayerGrabbedRef"sv, 463 },
		{ "GetKeywordItemCount"sv, 465 },
		{ "GetDestructionStage"sv, 470 },
		{ "GetIsAlignment"sv, 473 },
		{ "IsProtected"sv, 476 },
		{ "GetThreatRatio"sv, 477 },
		{ "GetIsUsedItemEquipType"sv, 479 },
		{ "IsCarryable"sv, 487 },
		{ "GetConcussed"sv, 488 },
		{ "GetMapMarkerVisible"sv, 491 },
		{ "PlayerKnows"sv, 493 },
		{ "GetPermanentActorValue"sv, 494 },
		{ "GetKillingBlowLimb"sv, 495 },
		{ "CanPayCrimeGold"sv, 497 },
		{ "GetDaysInJail"sv, 499 },
		{ "EPAlchemyGetMakingPoison"sv, 500 },
		{ "EPAlchemyEffectHasKeyword"sv, 501 },
		{ "GetAllowWorldInteractions"sv, 503 },
		{ "GetLastHitCritical"sv, 508 },
		{ "IsCombatTarget"sv, 513 },
		{ "GetVATSRightAreaFree"sv, 515 },
		{ "GetVATSLeftAreaFree"sv, 516 },
		{ "GetVATSBackAreaFree"sv, 517 },
		{ "GetVATSFrontAreaFree"sv, 518 },
		{ "GetLockIsBroken"sv, 519 },
		{ "IsPS3"sv, 520 },
		{ "IsWin32"sv, 521 },
		{ "GetVATSRightTargetVisible"sv, 522 },
		{ "GetVATSLeftTargetVisible"sv, 523 },
		{ "GetVATSBackTargetVisible"sv, 524 },
		{ "GetVATSFrontTargetVisible"sv, 525 },
		{ "IsInCriticalStage"sv, 528 },
		{ "GetXPForNextLevel"sv, 530 },
		{ "GetInfamy"sv, 533 },
		{ "GetInfamyViolent"sv, 534 },
		{ "GetInfamyNonViolent"sv, 535 },
		{ "GetQuestCompleted"sv, 543 },
		{ "IsGoreDisabled"sv, 547 },
		{ "IsSceneActionComplete"sv, 550 },
		{ "GetSpellUsageNum"sv, 552 },
		{ "GetActorsInHigh"sv, 554 },
		{ "HasLoaded3D"sv, 555 },
		{ "HasKeyword"sv, 560 },
		{ "HasRefType"sv, 561 },
		{ "LocationHasKeyword"sv, 562 },
		{ "LocationHasRefType"sv, 563 },
		{ "GetIsEditorLocation"sv, 565 },
		{ "GetIsAliasRef"sv, 566 },
		{ "GetIsEditorLocAlias"sv, 567 },
		{ "IsSprinting"sv, 568 },
		{ "IsBlocking"sv, 569 },
		{ "HasEquippedSpell"sv, 570 },
		{ "GetCurrentCastingType"sv, 571 },
		{ "GetCurrentDeliveryType"sv, 572 },
		{ "GetAttackState"sv, 574 },
		{ "GetEventData"sv, 576 },
		{ "IsCloserToAThanB"sv, 577 },
		{ "GetEquippedShout"sv, 579 },
		{ "IsBleedingOut"sv, 580 },
		{ "GetRelativeAngle"sv, 584 },
		{ "GetMovementDirection"sv, 589 },
		{ "IsInScene"sv, 590 },
		{ "GetRefTypeDeadCount"sv, 591 },
		{ "GetRefTypeAliveCount"sv, 592 },
		{ "GetIsFlying"sv, 594 },
		{ "IsCurrentSpell"sv, 595 },
		{ "SpellHasKeyword"sv, 596 },
		{ "GetEquippedItemType"sv, 597 },
		{ "GetLocationAliasCleared"sv, 598 },
		{ "GetLocAliasRefTypeDeadCount"sv, 600 },
		{ "GetLocAliasRefTypeAliveCount"sv, 601 },
		{ "IsWardState"sv, 602 },
		{ "IsInSameCurrentLocAsRef"sv, 603 },
		{ "IsInSameCurrentLocAsRefAlias"sv, 604 },
		{ "LocAliasIsLocation"sv, 605 },
		{ "GetKeywordDataForLocation"sv, 606 },
		{ "GetKeywordDataForAlias"sv, 608 },
		{ "LocAliasHasKeyword"sv, 610 },
		{ "IsNullPackageData"sv, 611 },
		{ "GetNumericPackageData"sv, 612 },
		{ "IsFurnitureAnimType"sv, 613 },
		{ "IsFurnitureEntryType"sv, 614 },
		{ "GetHighestRelationshipRank"sv, 615 },
		{ "GetLowestRelationshipRank"sv, 616 },
		{ "HasAssociationTypeAny"sv, 617 },
		{ "HasFamilyRelationshipAny"sv, 618 },
		{ "GetPathingTargetOffset"sv, 619 },
		{ "GetPathingTargetAngleOffset"sv, 620 },
		{ "GetPathingTargetSpeed"sv, 621 },
		{ "GetPathingTargetSpeedAngle"sv, 622 },
		{ "GetMovementSpeed"sv, 623 },
		{ "GetInContainer"sv, 624 },
		{ "IsLocationLoaded"sv, 625 },
		{ "IsLocAliasLoaded"sv, 626 },
		{ "IsDualCasting"sv, 627 },
		{ "GetVMQuestVariable"sv, 629 },
		{ "GetVMScriptVariable"sv, 630 },
		{ "IsEnteringInteractionQuick"sv, 631 },
		{ "IsCasting"sv, 632 },
		{ "GetFlyingState"sv, 633 },
		{ "IsInFavorState"sv, 635 },
		{ "HasTwoHandedWeaponEquipped"sv, 636 },
		{ "IsExitingInstant"sv, 637 },
		{ "IsInFriendStateWithPlayer"sv, 638 },
		{ "GetWithinDistance"sv, 639 },
		{ "GetActorValuePercent"sv, 640 },
		{ "IsUnique"sv, 641 },
		{ "GetLastBumpDirection"sv, 642 },
		{ "IsInFurnitureState"sv, 644 },
		{ "GetIsInjured"sv, 645 },
		{ "GetIsCrashLandRequest"sv, 646 },
		{ "GetIsHastyLandRequest"sv, 647 },
		{ "IsLinkedTo"sv, 650 },
		{ "GetKeywordDataForCurrentLocation"sv, 651 },
		{ "GetInSharedCrimeFaction"sv, 652 },
		{ "GetBribeSuccess"sv, 654 },
		{ "GetIntimidateSuccess"sv, 655 },
		{ "GetArrestedState"sv, 656 },
		{ "GetArrestingActor"sv, 657 },
		{ "EPTemperingItemIsEnchanted"sv, 659 },
		{ "EPTemperingItemHasKeyword"sv, 660 },
		{ "GetReplacedItemType"sv, 664 },
		{ "IsAttacking"sv, 672 },
		{ "IsPowerAttacking"sv, 673 },
		{ "IsLastHostileActor"sv, 674 },
		{ "GetGraphVariableInt"sv, 675 },
		{ "GetCurrentShoutVariation"sv, 676 },
		{ "ShouldAttackKill"sv, 678 },
		{ "GetActivatorHeight"sv, 680 },
		{ "EPMagic_IsAdvanceSkill"sv, 681 },
		{ "WornHasKeyword"sv, 682 },
		{ "GetPathingCurrentSpeed"sv, 683 },
		{ "GetPathingCurrentSpeedAngle"sv, 684 },
		{ "EPModSkillUsage_AdvanceObjectHasKeyword"sv, 691 },
		{ "EPModSkillUsage_IsAdvanceAction"sv, 692 },
		{ "EPMagic_SpellHasKeyword"sv, 693 },
		{ "GetNoBleedoutRecovery"sv, 694 },
		{ "EPMagic_SpellHasSkill"sv, 696 },
		{ "IsAttackType"sv, 697 },
		{ "IsAllowedToFly"sv, 698 },
		{ "HasMagicEffectKeyword"sv, 699 },
		{ "IsCommandedActor"sv, 700 },
		{ "IsStaggered"sv, 701 },
		{ "IsRecoiling"sv, 702 },
		{ "IsExitingInteractionQuick"sv, 703 },
		{ "IsPathing"sv, 704 },
		{ "GetShouldHelp"sv, 705 },
		{ "HasBoundWeaponEquipped"sv, 706 },
		{ "GetCombatTargetHasKeyword"sv, 707 },
		{ "GetCombatGroupMemberCount"sv, 709 },
		{ "IsIgnoringCombat"sv, 710 },
		{ "GetLightLevel"sv, 711 },
		{ "SpellHasCastingPerk"sv, 713 },
		{ "IsBeingRidden"sv, 714 },
		{ "IsUndead"sv, 715 },
		{ "GetRealHoursPassed"sv, 716 },
		{ "IsUnlockedDoor"sv, 718 },
		{ "IsHostileToActor"sv, 719 },
		{ "GetTargetHeight"sv, 720 },
		{ "IsPoison"sv, 721 },
		{ "WornApparelHasKeywordCount"sv, 722 },
		{ "GetItemHealthPercent"sv, 723 },
		{ "EffectWasDualCast"sv, 724 },
		{ "GetKnockedStateEnum"sv, 725 },
		{ "DoesNotExist"sv, 726 },
		{ "IsOnFlyingMount"sv, 730 },
		{ "CanFlyHere"sv, 731 },
		{ "IsFlyingMountPatrolQueud"sv, 732 },
		{ "IsFlyingMountFastTravelling"sv, 733 },
		{ "IsOverEncumbered"sv, 734 },
		{ "GetActorWarmth"sv, 735 },
		{ "GetSKSEVersion"sv, 1024 },
		{ "GetSKSEVersionMinor"sv, 1025 },
		{ "GetSKSEVersionBeta"sv, 1026 },
		{ "GetSKSERelease"sv, 1027 },
		{ "ClearInvalidRegistrations"sv, 1028 }
	};
};